---
title: "1. 基本架构"
date: 2019-11-01T00:00:00+08:00
categories:
- 使用flask创建restful风格接口
---

使用pycharm初始化一个新工程，选择python3.7，使用pipenv初始化虚拟环境...

<!-- more -->

![Xnip2019-10-24_09-12-49.jpg](https://i.loli.net/2019/10/24/EIqNPQOgsS9wzvC.jpg)

初始化完成后，在根目录创建一个名为**src**的python package，将除Pipfile和Pipfile.lock之外的所有项目拖到新建的app目录下，得到如下目录：

```text
.
├── Pipfile
├── Pipfile.lock
└── src
    ├── __init__.py
    ├── app.py
    ├── static
    └── templates
```

现在我们需改一下app.py代码，通过工厂函数创建Flask实例

```python
from flask import Flask


def create_app() -> Flask:
    app = Flask(__name__)

    @app.route('/')
    def hello_world():
        return 'Hello World!'

    return app
```

在根目录创建一个项目的入口文件main.py

```python
from src.app import create_app

app = create_app()

if __name__ == '__main__':
    app.run()
```

点击绿色三角就可以直接运行了，如果需要开启debug模式，配置启动参数，点击启动项中的**Edit Configurations**

![Xnip2019-10-24_08-50-10.jpg](https://i.loli.net/2019/10/24/XDM1sWcir2v3zbQ.jpg)

点击**Rerun**就可以看到配置生效

还可以通过配置文件配置应用，在src下创建config.py

```python
from flask import Config


class BasicConfig(Config):
    SECRET_KEY = 'you-will-never-guess'


class DevelopmentConfig(BasicConfig):
    ENV = "development"
    DEBUG = True


class TestingConfig(BasicConfig):
    ENV = "testing"
    TESTING = True


class ProductionConfig(BasicConfig):
    ENV = "production"


def env2config(env: str) -> Type[Union[DevelopmentConfig, TestingConfig, ProductionConfig]]:
    configs = {
        'development': DevelopmentConfig,
        'testing': TestingConfig,
        'production': ProductionConfig
    }
    return configs[env]
```

需要修改app.py

```python
from flask import Flask
from .config import env2config


def create_app(env: str) -> Flask:
    app = Flask(__name__)
    app.config.from_object(env2config(env))

    @app.route('/')
    def hello_world():
        return 'Hello World!'

    return app
```

> 通过python main.py和flask run启动的区别？

完善main.py

```python
from typing import Dict
import os
import click
from flask.cli import AppGroup
from src.app import create_app

env = os.getenv('FLASK_ENV', 'development')
app = create_app(env)
app_cli = AppGroup('app', help='some commands work with app.')


@app.shell_context_processor
def make_shell_context() -> Dict:
    return {
        "app": app
    }


@app_cli.command('print')
@click.argument('name')
def print_app_attr_by_name(name) -> None:
    """
    $ flask app print config
    <Config {...}>
    """
    print(getattr(app, name, None))


app.cli.add_command(app_cli)

if __name__ == '__main__':
    app.run()
```

现在开始使用第一个插件***flask_restful***，使用pipenv安装

```bash
pipenv install flask_restful
```

> 下载太慢可以修改Pipfile中的url为<https://pypi.douban.com/simple/>

在app.py中使用它

```python
from flask import Flask
from flask_restful import Api, Resource
from .config import env2config


def create_app(env: str) -> Flask:
    app = Flask(__name__)
    app.config.from_object(env2config(env))

    @app.route('/')
    def hello_world():
        return 'Hello World!'

    api = Api(app)

    @api.resource('/welcome')
    class WelcomeResource(Resource):
        def get(self):
            return {
                "message": "Welcome VimCoding"
            }

    return app
```

运行访问/welcome可以收到json格式响应。
